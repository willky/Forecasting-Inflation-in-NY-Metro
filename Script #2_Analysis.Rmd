---
title: "Inflation in the NY-Metro Area"
author: "William Kyeremateng"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    df_print: paged
spacing: double
---

<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

attach("cpi_use.RData")

library(knitr)
library(tidyverse)
library(markdown)
library(plotly)
library(ggthemes)
library(scales)
library(lubridate)
library(mice)
library(kableExtra)
library(AER)
library(dlookr)
library(summarytools)
library(visdat)
library(skimr)
library(Amelia)
library(gridExtra)
library(urca)
library(tseries)
library(TSstudio)
```

## Introduction

Inflation has been a major topic of discussion over the past couple of years. The COVID-19 pandemic and the shutdowns that ensued from it brought on global supply shortages, causing prices to surge in several industries. Additionally, the Russia-Ukraine conflict has compounded issues and led to sharp increases in oil prices worldwide. 

This project examines inflation in the New York Metro Area. It focuses mainly on headline and core inflation, as well as price changes among select items of importance.

## Section 1. Download CPI Data using BLS API

The data for this work is from the monthly CPI data published by the Bureau of Labor Statistics (BLS). The data is extracted using an BLS' API, and then transformed, loaded and cleaned for use in this analysis.

I extracted monthly data for all 61 items BLS publishes data for pertaining to the NY Metro Area. The data - `cpi_use` - is attached at the begining of this script and used for this analysis from here on out.^[See the `Data Extract File` for the API code used to extract the data]

#### Top 10 rows
```{r}
cpi_use %>% head(10) %>% 
  kbl(align = "rrrrrrrrrrrrrrr") %>% 
  kable_material(c("striped", "hover"),
                      html_font = "calibri") %>% 
  scroll_box(width = "100%", height = "300px")
```


#### Bottom 10 rows
```{r}
cpi_use %>% 
  tail(10) %>% 
  kbl(align = "rrrrrrrr") %>% 
  kable_material(c("striped", "hovered"),
                      html_font = "calibri") %>% 
  scroll_box(width = "100%", height = "300px")
```

#
The following are the observations from the tables above.

+ CPI for `Motor Vehicle Insurance` has been discontinued as og the end of 2021.

+ The CPI for the latest month (`r max(cpi_use$date)`) is not available via the API download even though they have been released and published on BLS's website website in excel and html formats. 

I delete the two items listed above during the data cleaning process. 


## 2. Data Wrangling

I remove the `Motor Vehicle Insurance` column and the last row of the merged data. Additionally, I convert the `year` variable to numeric and create a `date` column, which combines the month and year colums.

```{r, message=FALSE, echo=FALSE}
cpi_use <- 
  cpi_use %>% 
  mutate(date = as.POSIXct(strptime(paste0('1',cpi_use$periodName,cpi_use$year),'%d%B%Y')),
         year = as.numeric(year)) %>% 
  select(-period, -motor.vehicle.insurance) %>%
  slice(-max(row_number()))   
```


## 2. Exploratory Data Analysis

### 2.1. Data Summary and Structure {.tabset .tabset-fade .tabset-pills} 

The table below shows a summary of the data and distributions of  some of its variables.

#### Data Summary

```{r}
cpi_use %>% 
  skim() %>% 
  kbl() %>% 
  kable_material(c("striped", "hovered"),
                 html_font = "calibri") %>% 
  scroll_box(width = "100%", height = "300px")
```  


### 2.2. Missing Data 

The summary table shows that there are missing variables. Let's investigate further and figure out how to handle them.

```{r}
cpi_use %>% missmap(main = "Observed vs. Missing Values")
```

The chart above shows that there are 15 percent of rows are missing. The missing data are from earlier years when BLS did not collect CPI data for those variables. The missing values do not need to be replaced or removed as they will not affect our analysis in any way.

## Section 3. Data Analysis

In this section, I analyze the data and answer important questions about inflation for the most recent month (`r max(cpi_use$date)`) and recent trends using tables and visualizations.


### 2.1. 12-Month Percent Change in Inflation for the Latest Month

Let's calculate the 12-month percent change in CPI per month for all the variables and store that in a new data frame (`monthly_pchg`).

```{r, echo=FALSE}
monthly_pchg <- cpi_use %>% 
  arrange(date) %>%
  mutate(year = as.character(year)) %>% 
  mutate_if(is.numeric, 
            ~round((./lag(., 12)-1)*100, 1)) %>% 
  filter(year != "2003")


## Alternatively, we could use "Delt" function in "quantmod" package

#monthly_pchg %>% cpi_use %>% 
#  arrange(date) %>%
#  mutate(year = as.character(year)) %>%
#  mutate_if(is.numeric, ~Delt(., k=12, type = "log")) %>% 
#  filter(year != "2003")
```

Here is a table that shows the y-o-y percent changes in prices for all months.

```{r, echo=FALSE}
monthly_pchg %>% 
  mutate(year = as.numeric(year)) %>% 
  filter(year == max(year)) %>%
  kbl() %>% 
  kable_classic_2(c("striped", "hovered"),
                      html_font = "calibri") %>% 
  scroll_box(width = "100%", height = "300px")
```


#### 2.1. Headline and Core Inflation {.tabset .tabset-fade .tabset-pill}

Tab 1 shows the y-o-y percent changes in core and headline inflation for October 2022. 

Tab 2 shows the y-o-y percent changes in prices for some of the important items.

#### Headline & Core Inflation

```{r, echo=FALSE}
monthly_pchg %>% select(date, all.items, all.items.less.food.energy) %>% 
  filter(date == max(date)) %>% 
  rename('Headline' = all.items,
         'Core' = all.items.less.food.energy) %>% 
  pivot_longer(cols = 2:3,
               names_to =  "Item",
               values_to =  "p_chg",
               values_drop_na =  T) %>%
  ggplot(aes(x = Item, y = p_chg)) +
  geom_bar(position = 'dodge', fill = '#80CBC4', stat = "identity") +
  geom_text(aes(label = p_chg)) +
  theme_few() +
  theme(panel.grid = element_blank()) +
  labs(x = NULL,
       y = "Inflation Rate (%)",
       title = "12-Month Percent Change in Inflation, July 2022",
       subtitle = "Healine and Core CPI",
       caption = "Non seasonally adjusted data")
```

#### Select Items

```{r, echo=FALSE}
monthly_pchg %>% 
  select(date, food, rent.of.primary.residence,household.energy, 
         medical.care, apparel, tuition.other.school.fees.childcare,
         recreation, new.used.motor.vehicles, gasoline.all.types, energy) %>%
  rename('Food' = food,
         'Rent' = rent.of.primary.residence,
         'Home utilities' = household.energy,
         'Medical Care' = medical.care,
         'Apparel' = apparel,
         'Tuition & Child Care' = tuition.other.school.fees.childcare,
         'Recreation' = recreation,
         'Vehicles' = new.used.motor.vehicles,
         'Gasoline' = gasoline.all.types,
         'Energy' = energy) %>% 
  filter(date == max(date)) %>% 
  pivot_longer(cols = 2:11,
               names_to = "item",
               values_to = "p_chg",
               values_drop_na = T) %>% 
  ggplot(aes(x = reorder(item, -p_chg),
             y = p_chg)
  ) +
  geom_bar(position='dodge', fill = '#80CBC4', stat='identity') +
  #facet_wrap(~item) +
  geom_text(aes(label = p_chg)) +
  coord_flip() +
  theme_few() +
  theme(panel.grid.major = element_blank()) +
  labs(x = NULL,
       y = "Inflation Rate (%)",
       title = "12-Month Percent Change in Inflation, Oct. 2022",
       subtitle = "Select Items",
       caption = "Not seasonally adjusted")
```


### 2.2. Trend: YoY Change in Prices

In this section, I use line graphs to depict the trend in monthly inflation since 2004.

#### Headline & Core: : Trend in Inflation

```{r}
monthly_pchg %>% select(date, all.items, all.items.less.food.energy) %>% 
  rename('Headline (% Change)' = all.items,
         'Core (% Change)' = all.items.less.food.energy) %>% 
  pivot_longer(2:3,
               names_to = "item",
               values_to = "p_chg",
               values_drop_na = T) %>%
  filter(item %in% c("Headline (% Change)", 
                     "Core (% Change)")) %>% 
  plot_ly(x=~date, y=~p_chg, type = 'scatter',  mode = 'line', color = ~item) %>% 
  layout(title = "Monthly Headline & Core Inflation Since 2005",
         xaxis = list(title = ""),
         yaxis = list(title = "YoY Percent Change in Prices", ticksuffix = "%")
         )
```


### 2.3. Deep Dive into Select Items

A look at inflation trends for some of the important items.

#### Gasoline

```{r}
monthly_pchg %>%
  plot_ly(x = ~date, y = ~gasoline.unleaded.regular, type = 'scatter', 
          mode = 'line', name = "Regular Gas") %>% 
  add_trace(y = ~gasoline.unleaded.midgrade, type = 'scatter', 
            mode = 'line', name = 'Midgrade Gas') %>%
  add_trace(y = ~gasoline.unleaded.premium, type = 'scatter', 
            mode = 'line', name = 'Premium Gas') %>% 
  layout(xaxis = list(title = ""),
         yaxis = list(title = "YoY Percent Change", 
                      ticksuffix = "%"),
         title = "12-Month Percent Change in Gas Prices")
```


#### Food

```{r}
monthly_pchg %>%
  plot_ly(x = ~date, y = ~food.at.home, type = 'scatter', 
          mode = 'line', name = 'Food at Home') %>% 
  add_trace(y = ~food.away.from.home, type = 'scatter', 
            mode = 'line', name = 'Food Away from Home') %>% 
  layout(xaxis = list(title = ""),
         yaxis = list(title = "YoY Percent Change", 
                      ticksuffix = "%"),
         title = "12-Month Percent Change in Food Prices")
```


#### Food at Home

```{r}
monthly_pchg %>%
  plot_ly(x = ~date, y = ~meats.poultry.fish.egg, type = 'scatter', 
          mode = 'line', name = 'Meat, Poultry, Fish, Egg') %>%
  add_trace(y = ~cereals.bakery.products, type = 'scatter', 
            mode = 'line', name = 'Cereal & Bakery') %>% 
  add_trace(y = ~dairy.related.products, type = 'scatter', 
            mode = 'line', name = 'Dairy Products') %>%
  add_trace(y = ~fruits.vegetables, type = 'scatter', 
            mode = 'line', name = 'Fruits & Vegetables') %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "YoY Percent Change", 
                      ticksuffix = "%"),
         title = "12-Month Percent Change in Prices for Select Food Items")
```

#### Shelter

```{r}
monthly_pchg %>%
  plot_ly(x = ~date, y = ~rent.of.primary.residence, type = 'scatter', 
          mode = 'line', name = "Rent") %>% 
  add_trace(y = ~owners.equivalent.rent.of.primary.residence, type = 'scatter', 
            mode = 'line', name = 'Mortgage') %>% 
  layout(xaxis = list(title = ""),
         yaxis = list(title = "YoY Percent Change", 
                      ticksuffix = "%"),
         title = "12-Month Percent Change in the Cost of Shelter")
```


#### Vehicles

```{r}
monthly_pchg %>%
   plot_ly(x = ~date, y = ~new.vehicles, type = 'scatter', 
           mode = 'line', name = "New Vehicles") %>% 
  add_trace(y = ~used.cars.trucks, type = 'scatter', 
            mode = 'line', name = 'Used Vehicles') %>% 
  layout(xaxis = list(title = ""),
         yaxis = list(title = "YoY Percent Change", 
                      ticksuffix = "%"),
         title = "12-Month Percent Change in Vehicle Prices")
  
```


## 4. Forecasting Headline Inflation

In this section, I forecast headline inflation for the next 12 months using ARIMA time series models.

First, the monthly headline headline inflation data frame (`monthly_pchg`) is converted to a time series data in order to be used for the forecast.

```{r}
h_ts <- 
  monthly_pchg %>%
  select(date, all.items) %>% 
  mutate(date = as.Date(date)) %>% 
  arrange(date) %>% 
  select(-date)


h_ts <- h_ts %>%   
  ts(start = c(2004, 1), end = c(2022, 10), frequency = 12)
```


### 4.1. Summary and Plot

Take a quick look at the summary of the time series

```{r}
summary(h_ts)
```

A plot of the time series.

```{r}
library(ggfortify)

autoplot(h_ts) + labs(title = "Inflation Rate in NY-Metro Area",
                      x = "Month",
                      y = "Infaltion Rate (%)") + theme_economist()
```


### 4.2. Decompose the Series

```{r}
library(TSstudio)

ts_decompose(h_ts, type = "additive", showline = TRUE)
```


### 4.2. Check for stationarity

Look at the ACF and PACF of the series.

```{r}
library(gridExtra)
library(forecast)

grid.arrange(
    ggAcf(h_ts) + labs(title = "ACF of the Series"),
    ggPacf(h_ts) + labs(title = "PACF of the Series"),
    ncol = 2)
```

The ACF and PACF graphs show significant lags suggest that the time series may not be stationary, and may require differencing. But before differencing, I use the Augment Dickey Fuller, Phillips Perron and KPSS tests to verify if the series is truly non-stationary.^[Note that, the ADF and Phillips Perron tests are unit root tests with null hypothesis that "the series is not stationary or has is unit root." The KPSS test, on the other hand, is a stationarity test and therefore its a null hypothesis states that "the series is stationary or does not have unit root]

```{r}
library(tseries)

adf.test(h_ts, k=2)
```

```{r}
kpss.test(h_ts)
```

```{r}
pp.test(h_ts)
```

From above, all three tests agree that the series is non-stationary.


### 4.3. Differencing the series

To make the series stationary, I take the first difference as shown below.

```{r}
dh_ts <- diff(h_ts)

grid.arrange(
  ggAcf(dh_ts) + labs(title = "ACF of the Series (Difference)"),
  ggPacf(dh_ts) + labs(title = "PACF of the Series (Difference)"),
  ncol = 2)
```

Now, let's use the three test to verify stationarity of the series.

```{r}
adf.test(dh_ts, k=2)
```

```{r}
kpss.test(dh_ts)
```

```{r}
pp.test(dh_ts)
```

From the tests above, differencing the series makes it stationary.


### 4.4. In-sample Forecasting and Validation

Partition the data into training and testing sets.

```{r}
split_ts <- ts_split(h_ts, sample.out = 12)

train <- split_ts$train
test <- split_ts$test
```

To determine the arima terms to include in the model,  plot the diagnostics of the training set.

```{r}
arima_diag(train)
```

From the diagnostics plots, I can manually (using try-and-error) determine the ARIMA terms to include. However, I am going to use the 'auto.arima' function in R to determine the lags to include.

```{r}
auto_ARIMA <- auto.arima(train, seasonal = TRUE)

summary(auto_ARIMA)
```

The above suggests an ARIMA terms of 4,1,3 with SARIMA term of 0,0,2.

Plot the diagnostics of the model to make sure there are no unit roots.

```{r}
autoplot(auto_ARIMA)
```

The plot above shows that the model has no unit roots as all the roots are inside the unit circle.

Also, the residuals plot above shows no lags, which is a good thing.

```{r}
check_res(auto_ARIMA)
```


**In Sample Forecast**

```{r}
fcst_test <- forecast(auto_ARIMA, h = 12)
test_forecast(actual = h_ts, forecast.obj = fcst_test, test = test)
```

Check the accuracy of the model against the training set.

```{r}
accuracy(fcst_test, test)
```



### 4.5. Out of Sample Forecast

Fit an ARIMA model on the full data set.

```{r}
fit.ARIMA <- auto.arima(h_ts, seasonal = TRUE)

summary(fit.ARIMA)
```

Now, check the diagnostics residuals of the model.

```{r}
autoplot(fit.ARIMA)
```


```{r}
check_res(fit.ARIMA)
```

Let's use the model to forecast inflation for the next 12 months.

```{r}
forecast <- forecast(h_ts, model = fit.ARIMA, h = 12)

summary(forecast)
```

Plot the forecast with the actuals.

```{r}
plot_forecast(forecast) %>% 
  layout(
    title = "Actual & Forecasted Inflation Rates",
    xaxis = list(title = ""),
    yaxis = list(title = "Inflation Rate", 
            ticksuffix = "%")
  )
```


## 5. Conclusion

**Headline and Core Inflation**

Driven by a 39 percent surge in energy prices, headline inflation in the NY-Metro Area peaked at 6.7 percent in June 2022. Since then, headline inflation has gradually declined each month, dropping to six percent as of October 2022.

Core inflation, on the other hand, peaked in September 2022 at five percent and remained almost unchanged at 4.9 percent in October 2022.

**Headline Inflation Forecast**

Headline inflation will begin to see sharp declines over the next 12 months as the Fed's rate hikes continue to cool price increases. Prices will decelerating to 5.5 percent in November before inching up to 5.7 percent in December, driven by holiday spending. Inflation will decline gradually afterwards, reaching 3.1 percent by August 2023. Nonetheless, inflation will not fall to the Fed's target rate of two percent over the next year.




```{r}
save.image("CPI Env.RData")
```

